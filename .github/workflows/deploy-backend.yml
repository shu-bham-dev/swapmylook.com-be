name: Deploy backend to cPanel

on:
  push:
    branches:
      - main

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    env:
      # fallback / defaults (can be overridden by repo secrets)
      BACKEND_FTP_PORT: 21

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js (CI)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: (Optional) Install & run tests
        if: ${{ always() }}
        run: |
          # Optional tests: adjust or remove if you don't want tests in CI
          set -e
          echo "Installing dependencies for test run..."
          npm ci
          if [ -f package.json ] && grep -q "\"test\"" package.json; then
            echo "Running tests..."
            npm test || echo "Tests failed (continuing deploy)"; exit 0
          else
            echo "No test script found or tests skipped."
          fi

      - name: Deploy backend via FTP (upload code only)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.BACKEND_FTP_HOST }}
          username: ${{ secrets.BACKEND_FTP_USERNAME }}
          password: ${{ secrets.BACKEND_FTP_PASSWORD }}
          port: ${{ secrets.BACKEND_FTP_PORT || env.BACKEND_FTP_PORT }}
          protocol: ftp
          local-dir: ./
          server-dir: ${{ secrets.BACKEND_SERVER_DIR }}
          exclude: |
            **/.git*
            **/.github*
            node_modules/**
            tests/**
            coverage/**
            .env*
            .env.* 
            README.md
            .vscode/**
            .github/**
            package-lock.json
            yarn.lock

      - name: Ensure server dir exists (debug)
        if: ${{ always() }}
        run: |
          echo "Deployed files to: ${{ secrets.BACKEND_SERVER_DIR }}"
          echo "If files are not in expected location, verify BACKEND_SERVER_DIR secret."

      - name: (Optional) Trigger cPanel Node app restart via UAPI
        if: ${{ always() }}
        env:
          CPANEL_API_TOKEN: ${{ secrets.CPANEL_API_TOKEN }}
          CPANEL_HOST: ${{ secrets.CPANEL_HOST }}
          CPANEL_USER: ${{ secrets.CPANEL_USER }}
          CPANEL_APP_NAME: ${{ secrets.CPANEL_APP_NAME }}
        run: |
          # Only attempt restart if all required secrets are set
          if [ -n "$CPANEL_API_TOKEN" ] && [ -n "$CPANEL_HOST" ] && [ -n "$CPANEL_USER" ] && [ -n "$CPANEL_APP_NAME" ]; then
            echo "Triggering cPanel NodeJS app restart for app=$CPANEL_APP_NAME on host=$CPANEL_HOST"
            # Call UAPI NodeJsApp/restart_app - adjust endpoint if your cPanel version differs
            curl -s -S -m 20 -H "Authorization: cpanel $CPANEL_USER:$CPANEL_API_TOKEN" \
              "https://$CPANEL_HOST:2083/execute/NodeJsApp/restart_app?app=$CPANEL_APP_NAME" \
              -o /tmp/cpanel-restart-response.json || true
            echo "cPanel restart response:"
            cat /tmp/cpanel-restart-response.json || true
          else
            echo "cPanel restart skipped because one or more CPANEL_* secrets are not set."
          fi

      - name: Final status
        if: ${{ always() }}
        run: |
          echo "Backend deployment job finished. Check previous steps' logs for details."
